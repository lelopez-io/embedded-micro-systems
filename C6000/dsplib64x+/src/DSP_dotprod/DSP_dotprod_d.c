/* ======================================================================= */
/* DSP_dotprod_d.c --Dot product implementation                            */
/*                   Driver file implementation                            */
/*                                                                         */
/* Rev 0.0.1                                                               */
/*                                                                         */
/* ----------------------------------------------------------------------- */
/*            Copyright (c) 2007 Texas Instruments, Incorporated.          */
/*                           All Rights Reserved.                          */
/* ======================================================================= */

#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <limits.h>

/* Interface header files for the natural C and optimized C code */
#include "DSP_dotprod_cn.h"
#include "DSP_dotprod.h"

/* Kernel-specific array alignment requirements. */
#pragma DATA_ALIGN(m, 8);      /* DWord-aligned.*/
#pragma DATA_ALIGN(n, 8);      /* DWord-aligned.*/

/* Parameters of fixed vector set. */
#define N   (256)                   /* Number of samples                    */
#define PAD (16)                    /* Amount of pad (for catching overrun) */

/* Initialized arrays with fixed test data. */
short m[N + 2*PAD] =
{
    -0x38D9,  0x07A2,  0x15E6, -0x60C6, -0x0020, -0x6123,  0x369A,  0x0358,
    -0x02D5, -0x55D0, -0x22F2,  0x0945,  0x54DE, -0x2E11, -0x6ADE,  0x3DD0,
    -0x1675,  0x1BEC,  0x3D53, -0x1A35, -0x1F57,  0x6BB0, -0x6FBC, -0x1AD2,
     0x4F9C,  0x6FA8, -0x5C9F,  0x4C7B,  0x341B,  0x6BE1, -0x0BD6,  0x06E0,
     0x3979,  0x6BB6,  0x7C9F,  0x2DA2, -0x51B1,  0x5C0A,  0x3F44, -0x79C1,
     0x5809, -0x7483, -0x17AD, -0x5E29,  0x78CE,  0x0228, -0x137B,  0x1B54,
    -0x5DAE,  0x4F52, -0x5901, -0x7728, -0x3202,  0x36AB,  0x06E3, -0x7D20,
     0x3305, -0x4476,  0x40FC,  0x5AB7,  0x70D0,  0x19A6, -0x06EC, -0x0A62,
     0x6950,  0x21D5, -0x7CA1,  0x433E,  0x73B0,  0x7449, -0x6570, -0x192F,
     0x47E7,  0x2BD0,  0x250F,  0x7896,  0x32AF,  0x6194,  0x7DC9, -0x0BFF,
     0x1156,  0x1FDE, -0x45D7, -0x32D5, -0x6E09,  0x3352, -0x7D52,  0x2008,
     0x2E8E,  0x663C, -0x1E61, -0x6E2A, -0x7E8C, -0x63B5, -0x5B99,  0x4A57,
     0x46B3,  0x555C, -0x49F1, -0x5EC0, -0x473C,  0x16BC,  0x0855, -0x1D88,
    -0x5FD6,  0x3574,  0x7BEB, -0x3F77, -0x4897, -0x75F4,  0x4C4F, -0x1B25,
    -0x3C16, -0x78A6, -0x7132,  0x2D2F,  0x0331,  0x34C6,  0x1A20,  0x0BD8,
     0x5605, -0x7168, -0x6ADD, -0x7ECB, -0x5418, -0x3038, -0x0FBB,  0x4DF4,
     0x3B7C,  0x15C4, -0x1004, -0x4479,  0x0145, -0x073E,  0x36EF, -0x7095,
    -0x09B6,  0x7811,  0x5F34, -0x5C5E, -0x63E6, -0x241A, -0x74C5, -0x620A,
     0x42B1, -0x17D2,  0x02CC,  0x5779, -0x6841,  0x12E1,  0x52B5,  0x61CC,
    -0x0534, -0x09AB,  0x778B,  0x2B9C,  0x13C4, -0x2CF0, -0x7AEB,  0x5BEF,
     0x325C,  0x56A2,  0x55D8, -0x4560, -0x0F23,  0x56F6, -0x3FC3,  0x57AE,
    -0x662E, -0x1453, -0x2A22,  0x40C0, -0x2CEF,  0x78F4, -0x688A,  0x676E,
     0x16A6,  0x0B5E, -0x3B19,  0x2FCA,  0x5F26, -0x55C2,  0x1CF0,  0x16AD,
    -0x5425,  0x0703, -0x4E07,  0x0B40, -0x46AC,  0x1013, -0x487E, -0x1BB5,
    -0x6F2B, -0x0D59,  0x5DB7,  0x7DC1,  0x472E, -0x11D2,  0x2EA3, -0x06F1,
    -0x699B, -0x565A,  0x6C7F, -0x5552, -0x542C,  0x4C83, -0x0454,  0x1E6E,
    -0x3CEA,  0x1B89,  0x4FC6, -0x31F0,  0x0761, -0x1FCE, -0x28A8, -0x0A6F,
     0x33BB, -0x32ED,  0x78B7,  0x0EC1,  0x7B95,  0x33BD, -0x7785,  0x7199,
     0x3941, -0x595F, -0x36EC, -0x6831, -0x1E35,  0x087D, -0x0AF6, -0x76D6,
    -0x4749, -0x0E45,  0x4152, -0x14DE, -0x2EE2,  0x065E,  0x7151,  0x332E,
    -0x345C, -0x5616, -0x140B, -0x7E9B, -0x2222, -0x6332,  0x4E75, -0x6227,
    -0x6273, -0x0231,  0x1132, -0x66D3,  0x133E,  0x2CF6, -0x57CC, -0x620A,
    -0x7236,  0x187B, -0x5733,  0x5159, -0x46C3,  0x6D34,  0x77DE,  0x7067,
    -0x776E,  0x2A04, -0x01CB,  0x01BF,  0x4EDB,  0x19CC, -0x2169, -0x5112,
    -0x51BB, -0x52A6, -0x501D, -0x31F0, -0x367F, -0x3321, -0x4429, -0x7ECD,
     0x2F03, -0x11A2, -0x3206, -0x7C03,  0x1AB4,  0x33A4,  0x7323,  0x1A0B
};

short n[N + 2*PAD] =
{
     0x6A73, -0x2EC6,  0x5523, -0x5563, -0x19FE,  0x6FDE,  0x050F,  0x6FFA,
     0x49D2, -0x210A, -0x2454, -0x20E9, -0x76D3, -0x4172,  0x567B,  0x2B00,
    -0x17BB, -0x7CB3,  0x7CE7,  0x6C83,  0x52A0,  0x61EF, -0x3BEE, -0x1466,
     0x6D66, -0x623C,  0x09C6,  0x1C16,  0x0615, -0x3C59, -0x0CFA, -0x50F4,
     0x2B0E,  0x4002,  0x7ABE,  0x5583, -0x6176, -0x1DBD, -0x24EC, -0x661E,
     0x0069, -0x429D, -0x6221,  0x6FA3,  0x466C, -0x0A1B,  0x19B9, -0x2343,
    -0x0CBE, -0x142D,  0x0337,  0x4A5D, -0x65FA,  0x5445,  0x7EBB, -0x05AC,
     0x1890, -0x5220,  0x316F,  0x26CB,  0x2930, -0x6123, -0x2024,  0x39BB,
    -0x55BB, -0x47F1,  0x0EA7, -0x4561,  0x323B,  0x2066,  0x24E4,  0x57ED,
     0x6B5F, -0x6387, -0x6A68, -0x7134, -0x59DF, -0x7E74, -0x6B2B, -0x7972,
     0x4630,  0x0D9B, -0x3E0F, -0x7497,  0x62F4, -0x5D1D,  0x696E, -0x5C0D,
     0x2EF3,  0x666E, -0x420E, -0x2526, -0x4C75, -0x35E1, -0x6316, -0x5899,
     0x3A96,  0x72BE,  0x554E, -0x06CB,  0x126E,  0x0B8A, -0x0702,  0x68B4,
     0x07CC,  0x76C1, -0x5BB6,  0x0FE7,  0x290B, -0x1346,  0x6213, -0x781A,
     0x5655,  0x74EC,  0x0116, -0x7761,  0x091D,  0x4E87,  0x73CB, -0x51AA,
    -0x146E, -0x4AFA,  0x3472, -0x1893, -0x4EA2, -0x6CBE,  0x3BB9,  0x02E8,
    -0x4FAE, -0x717A, -0x1F7A, -0x1BD1, -0x348D,  0x0629,  0x5B63, -0x1F66,
     0x0FDF,  0x6B23,  0x3406, -0x43CC, -0x56E2, -0x7BDE,  0x4D81, -0x30BA,
    -0x6CB3,  0x12AB, -0x2475, -0x31DF, -0x7656,  0x5FAC, -0x088A, -0x4658,
    -0x37FA,  0x2C1D,  0x2935,  0x6F1B,  0x0E96, -0x75E8,  0x7A15,  0x65A5,
     0x5C9E,  0x0FFA, -0x7179,  0x0329,  0x058A, -0x0302,  0x3F9A,  0x28D2,
     0x7ADC, -0x4020,  0x4187,  0x52E0,  0x6181,  0x5CF6,  0x48EB, -0x1AC7,
     0x6C08,  0x3C5B,  0x341A,  0x2141,  0x7B36, -0x1D76, -0x3FEA,  0x3A61,
     0x7A7D,  0x0403,  0x3CA6,  0x0BE7, -0x6E2B, -0x7A90, -0x38F1,  0x0091,
     0x0A75, -0x2236, -0x7514, -0x6B97, -0x7715,  0x5DFE, -0x7A54, -0x00A7,
    -0x03E8, -0x2269,  0x5228, -0x7BFD, -0x1A72,  0x4DE1,  0x78E6, -0x1BA7,
     0x4ECA, -0x51E6, -0x428F,  0x7A79,  0x14D2, -0x15EC,  0x0259,  0x7844,
    -0x0949,  0x18E6,  0x1B54, -0x36C1, -0x1F8F, -0x5FEC,  0x39FD,  0x1B2A,
     0x06A5, -0x373E,  0x4DB5, -0x7420,  0x38C0,  0x1E5A, -0x07D8,  0x78F9,
     0x0901,  0x5443,  0x7AEC, -0x055C,  0x2BD7, -0x08F4,  0x2BCA,  0x7D4A,
    -0x5ED5, -0x765F, -0x07DE,  0x0573,  0x2803, -0x7107,  0x60EF, -0x6D9E,
     0x6B09, -0x1432, -0x7F0E,  0x2C00,  0x7D74,  0x3CCB, -0x6787,  0x117B,
     0x17CF, -0x7E37, -0x61B9, -0x6FD2,  0x1828, -0x4781,  0x5220, -0x02B9,
    -0x31EC, -0x26C5,  0x5B76,  0x52B3, -0x7CE1, -0x44E4, -0x204E, -0x0743,
    -0x32E7,  0x5347,  0x2FA3,  0x2602,  0x26C3, -0x155A, -0x1374,  0x7C16,
     0x475D, -0x5A60,  0x3558,  0x2B71, -0x3866, -0x00A8,  0x5861,  0x531B
};


/* 
    The testInit function performs any initialization required before the
    test can be run.
*/
void dotprod_testInit()  {}


/*
    The test function performs the test for the dotprod routine. The inputs
    for the test are provided as arguments to the function. The function also
    benchmarks the Kernel and provides the timimg information.
    After the test is run, the function compares the natural C and optimized
    C output to ensure that the test ran correctly.
*/
int dotprod_test(short * m_c, short * m_cn, short * n_c, short * n_cn,
                 int count, unsigned int * time, unsigned int * time_n)
{
    int result, result_n;
    int fail = 0;
    clock_t t_start, t_stop;

    /* Call the optimized C kernel */
    t_start = clock();
    result = DSP_dotprod(m_c, n_c, count);
    t_stop = clock();

    *time = t_stop - t_start;

    /* Call the natural C kernel */
    t_start = clock();
    result_n = DSP_dotprod_cn(m_cn, n_cn, count);
    t_stop = clock();

    *time_n = t_stop - t_start;

    /* Ensure that the output match for both the kernels */
    if (result != result_n) {
            fail = 1;
    }

    /* Return with Pass/Fail information */
    if (fail) {
        return (1);
    }
    else {
        return (0);
    }
}

/* Top level driver for the test. */
int main()
{
    clock_t t_overhead, time, time_n; 
    clock_t timeTotal = 0, timeTotal_n = 0;
    int countTotal = 0, countTotal_n = 0;
    int fail = 0, i;
    float timeItter, timeItter_n;

    /*  Compute the overhead of calling clock() twice to get timing info. */
    t_overhead = clock();
    t_overhead = clock() - t_overhead;

    /*
        TEST 1: Verify the handling of the input count by the function.
        The Kernel should be able to run from the minimum count (4) to higher
        counts. Test with various count values. 
    */
    for (i = 0; i <= N/4; i ++) {
        dotprod_testInit();
        fail += dotprod_test(m, m, n, n, i*4, &time, &time_n);

        /* Accumulate the total time taken by the Kernel.*/
        timeTotal += time - t_overhead;
        countTotal += i*4;
        timeTotal_n += time_n - t_overhead;
        countTotal_n += i*4;
    }
    /* Calculate the time for one itteration */
    timeItter = timeTotal/(countTotal * 1.0);
    timeItter_n = timeTotal_n/(countTotal_n * 1.0);

    /* -------------------------------------------------------------------- */
    /*  Print timing results.                                               */
    /* -------------------------------------------------------------------- */
    if (!fail)
        printf("DSP_dotprod\tnatC: %f\toptC: %f\n", timeItter_n, timeItter);
    else
        printf("DSP_dotprod: Result Failure\n");

    return (fail);
}

/* ======================================================================== */
/*  End of file:  DSP_dotprod_d.c                                           */
/* ------------------------------------------------------------------------ */
/*            Copyright (c) 2007 Texas Instruments, Incorporated.           */
/*                           All Rights Reserved.                           */
/* ======================================================================== */

